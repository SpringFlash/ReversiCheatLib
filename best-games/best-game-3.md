# Алгоритм NegaScout и продвинутые эвристики для Реверси

## Алгоритм NegaScout

NegaScout (также известный как Principal Variation Search или PVS) представляет собой усовершенствованную версию алгоритма Negamax с альфа-бета отсечением, обеспечивающую более эффективный поиск в дереве игры. Алгоритм был разработан Александром Рейнфельдом в 1983 году и показывает особенно высокую эффективность для игр с хорошо упорядоченными ходами, таких как Реверси.

### Принцип работы

NegaScout основан на предположении, что первый исследуемый ход, вероятно, будет лучшим. Это позволяет использовать "нулевое окно" (`alpha, alpha+1`) для быстрой проверки остальных ходов:

1. Первый ход исследуется с полным окном (`alpha, beta`)
2. Остальные ходы сначала проверяются с нулевым окном для быстрого отсечения
3. Если ход показывает лучший результат, чем первый, выполняется повторный поиск с полным окном

### Псевдокод NegaScout

```
function negascout(node, depth, α, β, color)
    if node это лист или depth = 0
        return color * evaluate(node)

    b = β // Исходная верхняя граница

    for (каждый дочерний узел child по порядку)
        // Полный поиск для первого хода
        if child это первый дочерний узел
            score = -negascout(child, depth-1, -b, -α, -color)
        else
            // Нулевое окно для быстрой проверки
            score = -negascout(child, depth-1, -α-1, -α, -color)

            // Повторный поиск с полным окном, если нужно
            if α < score && score < β
                score = -negascout(child, depth-1, -β, -score, -color)

        α = max(α, score)

        // Отсечение
        if α ≥ β
            return α

        b = α + 1 // Устанавливаем новую верхнюю границу

    return α
```

### Преимущества NegaScout над стандартным альфа-бета

1. **Более эффективное отсечение**: В среднем исследует на 10-40% меньше узлов по сравнению с обычным альфа-бета.
2. **Лучшая производительность при хорошем упорядочении ходов**: Для Реверси, где углы и края имеют очевидный приоритет, это дает существенный выигрыш.
3. **Быстрое отсечение слабых вариантов**: Нулевое окно позволяет быстро отбросить заведомо плохие ходы.

## Продвинутые эвристики оценки позиции

### 1. Узорное распознавание (Pattern Recognition)

Один из самых мощных методов оценки позиции в Реверси - это распознавание узоров (паттернов). Программа Logistello, одна из сильнейших программ по игре в Реверси, активно использовала этот подход.

#### Типы узоров:

1. **Локальные конфигурации 2×2, 3×3**

   ```
   XX   XOO   XXX
   XO   OXO   OOO
        OOX   XOX
   ```

2. **Горизонтальные/вертикальные линии (ряды/столбцы)**

   ```
   XOOOOX  XOXOOX  XXXOOO
   ```

3. **Диагонали**

   ```
   X
    O
     X
      O
   ```

4. **Краевые конфигурации**
   ```
   XXOOOX  XXXOXO
   ```

Каждому узору присваивается вес на основе статистики или машинного обучения.

### 2. Мобильность разных типов

#### Актуальная мобильность

Количество легальных ходов в текущей позиции. Рассчитывается непосредственно из текущего состояния доски.

#### Потенциальная мобильность

Оценка будущих возможностей для ходов:

1. **Пустые клетки рядом с фишками противника**: Каждая такая клетка потенциально может стать доступным ходом.
2. **Фронтир**: Количество дисков, примыкающих к пустым клеткам. Меньший фронтир обычно означает лучшую позицию.

#### Принудительные ходы

Ходы, которые оставляют противнику только 1-2 варианта, позволяя контролировать игру.

### 3. Стабильность дисков

#### Категории стабильности:

1. **Абсолютно стабильные**: Не могут быть перевернуты до конца игры (например, угловые фишки).
2. **Условно стабильные**: Не могут быть перевернуты в текущей конфигурации, но могут стать нестабильными после добавления фишек.
3. **Нестабильные**: Могут быть перевернуты при следующих ходах.

Алгоритм определения стабильных дисков:

```
1. Отметить все угловые фишки как стабильные
2. Итеративно распространять стабильность:
   а) Диск стабилен горизонтально, если соседние диски того же цвета по горизонтали стабильны или достигнут край
   б) Аналогично для вертикали и диагоналей
   в) Диск полностью стабилен, если стабилен по всем направлениям
3. Повторять до тех пор, пока новые стабильные диски не перестанут появляться
```

### 4. Паритет

На поздних стадиях игры важен паритет пустых клеток в регионах доски:

- Если в изолированном регионе четное число пустых клеток, игрок, делающий первый ход в регионе, вынужден сделать и последний ход.
- Если нечетное - игрок делает последний ход и получает преимущество.

Эвристика паритета особенно важна в поздней стадии игры (последние 15-20 ходов).

### 5. Многоуровневая оценочная функция

Современные программы используют разные оценочные функции на разных стадиях игры:

1. **Дебют (1-15 ходов)**:

   - Приоритет: мобильность и контроль центра
   - Избегание ходов рядом с углами
   - Использование базы дебютов

2. **Миттельшпиль (16-40 ходов)**:

   - Приоритет: стабильность дисков и захват углов
   - Баланс между мобильностью и территорией
   - Распознавание паттернов

3. **Эндшпиль (последние 20 ходов)**:
   - Приоритет: подсчет фишек и паритет
   - Точный расчет до конца игры при возможности
   - Минимизация ходов противника

## Техники машинного обучения для оценочных функций

### 1. Логистическая регрессия

Метод, используемый в программе Logistello, для комбинирования различных факторов оценки позиции:

```
eval = w1*pattern1 + w2*pattern2 + ... + wn*patternN +
       v1*mobility + v2*stability + ...
```

Веса (w1, w2, ..., v1, v2, ...) определяются через обучение на большой базе игр.

### 2. Временные различия (TD-Lambda)

Метод обучения с подкреплением, позволяющий программе улучшать свою оценочную функцию через самоигру:

1. Программа играет против себя
2. После каждой игры оценки позиций корректируются на основе конечного результата
3. Постепенно программа "учится" более точно оценивать позиции

### 3. Нейронные сети

Современный подход с использованием глубоких нейронных сетей для оценки позиции:

1. **Входные данные**: Состояние доски (обычно 8×8×3 тензор, где третье измерение кодирует {пусто, черные, белые})
2. **Архитектура**: Сверточные слои для выявления паттернов + полносвязные слои
3. **Выходные данные**: Оценка вероятности выигрыша

## Заключение

NegaScout в сочетании с продвинутыми эвристиками оценки позиции и техниками машинного обучения обеспечивает исключительно сильную игру в Реверси. Современные программы, использующие эти методы, способны играть на уровне мировых чемпионов.

Оптимальный подход для создания сильного игрока в Реверси заключается в комбинировании различных методов:

1. Эффективный алгоритм поиска (NegaScout)
2. Мощные эвристики оценки позиции
3. Машинное обучение для настройки параметров
4. Базы дебютов и эндшпилей
5. Адаптация стратегии в зависимости от стадии игры
